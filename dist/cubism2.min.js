!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@pixi/core"),require("@pixi/display")):"function"==typeof define&&define.amd?define(["exports","@pixi/core","@pixi/display"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).PIXI=e.PIXI||{},e.PIXI.live2d=e.PIXI.live2d||{}),e.PIXI,e.PIXI)}(this,(function(e,t,s){"use strict";var i=Object.defineProperty,r=Math.pow,o=(e,t,s)=>((e,t,s)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s),n=(e,t,s)=>new Promise(((i,r)=>{var o=e=>{try{a(s.next(e))}catch(t){r(t)}},n=e=>{try{a(s.throw(e))}catch(t){r(t)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(o,n);a((s=s.apply(e,t)).next())}));var a,l;(l=a||(a={})).supportMoreMaskDivisions=!0,l.setOpacityFromMotion=!1;const d={LOG_LEVEL_VERBOSE:0,LOG_LEVEL_WARNING:1,LOG_LEVEL_ERROR:2,LOG_LEVEL_NONE:999,logLevel:1,sound:!0,motionSync:!0,motionFadingDuration:500,idleMotionFadingDuration:2e3,expressionFadingDuration:500,preserveExpressionOnMotion:!0,cubism4:a},h={log(e,...t){d.logLevel<=d.LOG_LEVEL_VERBOSE&&console.log(`[${e}]`,...t)},warn(e,...t){d.logLevel<=d.LOG_LEVEL_WARNING&&console.warn(`[${e}]`,...t)},error(e,...t){d.logLevel<=d.LOG_LEVEL_ERROR&&console.error(`[${e}]`,...t)}};function u(e,t,s){return e<t?t:e>s?s:e}function c(e,t){return Math.random()*(t-e)+e}function p(e,t,s,i,r){const o=t[i];null!==o&&typeof o===e&&(s[r]=o)}function g(e,t,s,i,r){const o=t[i];Array.isArray(o)&&(s[r]=o.filter((t=>null!==t&&typeof t===e)))}function f(e){let t=e.lastIndexOf("/");return-1!=t&&(e=e.slice(0,t)),t=e.lastIndexOf("/"),-1!==t&&(e=e.slice(t+1)),e}function m(e,t){const s=e.indexOf(t);-1!==s&&e.splice(s,1)}class y extends t.utils.EventEmitter{constructor(e,t){super(),o(this,"tag"),o(this,"settings"),o(this,"expressions",[]),o(this,"defaultExpression"),o(this,"currentExpression"),o(this,"reserveExpressionIndex",-1),o(this,"destroyed",!1),this.settings=e,this.tag=`ExpressionManager(${e.name})`}init(){this.defaultExpression=this.createExpression({},void 0),this.currentExpression=this.defaultExpression,this.stopAllExpressions()}loadExpression(e){return n(this,null,(function*(){if(!this.definitions[e])return void h.warn(this.tag,`Undefined expression at [${e}]`);if(null===this.expressions[e])return void h.warn(this.tag,`Cannot set expression at [${e}] because it's already failed in loading.`);if(this.expressions[e])return this.expressions[e];const t=yield this._loadExpression(e);return this.expressions[e]=t,t}))}_loadExpression(e){throw new Error("Not implemented.")}setRandomExpression(){return n(this,null,(function*(){if(this.definitions.length){const e=[];for(let t=0;t<this.definitions.length;t++)null!==this.expressions[t]&&this.expressions[t]!==this.currentExpression&&t!==this.reserveExpressionIndex&&e.push(t);if(e.length){const t=Math.floor(Math.random()*e.length);return this.setExpression(t)}}return!1}))}resetExpression(){this._setExpression(this.defaultExpression),this.currentExpression=this.defaultExpression}restoreExpression(){this._setExpression(this.currentExpression)}setExpression(e){return n(this,null,(function*(){if("number"!=typeof e&&(e=this.getExpressionIndex(e)),!(e>-1&&e<this.definitions.length))return!1;if(e===this.expressions.indexOf(this.currentExpression))return!1;this.reserveExpressionIndex=e;const t=yield this.loadExpression(e);return!(!t||this.reserveExpressionIndex!==e)&&(this.reserveExpressionIndex=-1,this.currentExpression=t,this._setExpression(t),!0)}))}update(e,t){return!this.isFinished()&&this.updateParameters(e,t)}destroy(){this.destroyed=!0,this.emit("destroy");this.definitions=void 0,this.expressions=void 0}}const x=40/7.5,v=1/150;class M{constructor(){o(this,"targetX",0),o(this,"targetY",0),o(this,"x",0),o(this,"y",0),o(this,"vx",0),o(this,"vy",0)}focus(e,t,s=!1){this.targetX=u(e,-1,1),this.targetY=u(t,-1,1),s&&(this.x=this.targetX,this.y=this.targetY)}update(e){const t=this.targetX-this.x,s=this.targetY-this.y;if(Math.abs(t)<.01&&Math.abs(s)<.01)return;const i=Math.sqrt(r(t,2)+r(s,2)),o=x/(1e3/e);let n=o*(t/i)-this.vx,a=o*(s/i)-this.vy;const l=Math.sqrt(r(n,2)+r(a,2)),d=o*v*e;l>d&&(n*=d/l,a*=d/l),this.vx+=n,this.vy+=a;const h=Math.sqrt(r(this.vx,2)+r(this.vy,2)),u=.5*(Math.sqrt(r(d,2)+8*d*i)-d);h>u&&(this.vx*=u/h,this.vy*=u/h),this.x+=this.vx,this.y+=this.vy}}class E{constructor(e){o(this,"json"),o(this,"name"),o(this,"url"),o(this,"pose"),o(this,"physics"),this.json=e;const t=e.url;if("string"!=typeof t)throw new TypeError("The `url` field in settings JSON must be defined as a string.");this.url=t,this.name=f(this.url)}resolveURL(e){return t.utils.url.resolve(this.url,e)}replaceFiles(e){this.moc=e(this.moc,"moc"),void 0!==this.pose&&(this.pose=e(this.pose,"pose")),void 0!==this.physics&&(this.physics=e(this.physics,"physics"));for(let t=0;t<this.textures.length;t++)this.textures[t]=e(this.textures[t],`textures[${t}]`)}getDefinedFiles(){const e=[];return this.replaceFiles((t=>(e.push(t),t))),e}validateFiles(e){const t=(t,s)=>{const i=this.resolveURL(t);if(!e.includes(i)){if(s)throw new Error(`File "${t}" is defined in settings, but doesn't exist in given files`);return!1}return!0};[this.moc,...this.textures].forEach((e=>t(e,!0)));return this.getDefinedFiles().filter((e=>t(e,!1)))}}var b=(e=>(e[e.NONE=0]="NONE",e[e.IDLE=1]="IDLE",e[e.NORMAL=2]="NORMAL",e[e.FORCE=3]="FORCE",e))(b||{});class P{constructor(){o(this,"tag"),o(this,"debug",!1),o(this,"currentPriority",0),o(this,"reservePriority",0),o(this,"currentGroup"),o(this,"currentIndex"),o(this,"reservedGroup"),o(this,"reservedIndex"),o(this,"reservedIdleGroup"),o(this,"reservedIdleIndex")}reserve(e,t,s){if(s<=0)return h.log(this.tag,"Cannot start a motion with MotionPriority.NONE."),!1;if(e===this.currentGroup&&t===this.currentIndex)return h.log(this.tag,"Motion is already playing.",this.dump(e,t)),!1;if(e===this.reservedGroup&&t===this.reservedIndex||e===this.reservedIdleGroup&&t===this.reservedIdleIndex)return h.log(this.tag,"Motion is already reserved.",this.dump(e,t)),!1;if(1===s){if(0!==this.currentPriority)return h.log(this.tag,"Cannot start idle motion because another motion is playing.",this.dump(e,t)),!1;if(void 0!==this.reservedIdleGroup)return h.log(this.tag,"Cannot start idle motion because another idle motion has reserved.",this.dump(e,t)),!1;this.setReservedIdle(e,t)}else{if(s<3){if(s<=this.currentPriority)return h.log(this.tag,"Cannot start motion because another motion is playing as an equivalent or higher priority.",this.dump(e,t)),!1;if(s<=this.reservePriority)return h.log(this.tag,"Cannot start motion because another motion has reserved as an equivalent or higher priority.",this.dump(e,t)),!1}this.setReserved(e,t,s)}return!0}start(e,t,s,i){if(1===i){if(this.setReservedIdle(void 0,void 0),0!==this.currentPriority)return h.log(this.tag,"Cannot start idle motion because another motion is playing.",this.dump(t,s)),!1}else{if(t!==this.reservedGroup||s!==this.reservedIndex)return h.log(this.tag,"Cannot start motion because another motion has taken the place.",this.dump(t,s)),!1;this.setReserved(void 0,void 0,0)}return!!e&&(this.setCurrent(t,s,i),!0)}complete(){this.setCurrent(void 0,void 0,0)}setCurrent(e,t,s){this.currentPriority=s,this.currentGroup=e,this.currentIndex=t}setReserved(e,t,s){this.reservePriority=s,this.reservedGroup=e,this.reservedIndex=t}setReservedIdle(e,t){this.reservedIdleGroup=e,this.reservedIdleIndex=t}isActive(e,t){return e===this.currentGroup&&t===this.currentIndex||e===this.reservedGroup&&t===this.reservedIndex||e===this.reservedIdleGroup&&t===this.reservedIdleIndex}reset(){this.setCurrent(void 0,void 0,0),this.setReserved(void 0,void 0,0),this.setReservedIdle(void 0,void 0)}shouldRequestIdleMotion(){return void 0===this.currentGroup&&void 0===this.reservedIdleGroup}shouldOverrideExpression(){return!d.preserveExpressionOnMotion&&this.currentPriority>1}dump(e,t){if(this.debug){return`\n<Requested> group = "${e}", index = ${t}\n`+["currentPriority","reservePriority","currentGroup","currentIndex","reservedGroup","reservedIndex","reservedIdleGroup","reservedIdleIndex"].map((e=>"["+e+"] "+this[e])).join("\n")}return""}}const w=.5,I=new WeakMap,O=new WeakMap,L=new WeakMap,T=new WeakMap,_=new WeakMap;class F{static get volume(){return this._volume}static set volume(e){this._volume=(e>1?1:e<0?0:e)||0,this.audios.forEach((e=>e.volume=this._volume))}static add(e,t,s,i){const r=new Audio(e);return r.volume=this._volume,r.preload="auto",r.crossOrigin=i,I.set(r,{ended:()=>{this.dispose(r),null==t||t()},error:t=>{this.dispose(r),h.warn("SoundManager",`Error occurred on "${e}"`,t.error),null==s||s(t.error)}}),r.addEventListener("ended",I.get(r).ended),r.addEventListener("error",I.get(r).error),this.audios.push(r),r}static play(e){return new Promise(((t,s)=>{var i;null==(i=e.play())||i.catch((t=>{e.dispatchEvent(new ErrorEvent("error",{error:t})),s(t)})),e.readyState===e.HAVE_ENOUGH_DATA?t():(O.set(e,t),e.addEventListener("canplaythrough",t))}))}static addContext(e){const t=new AudioContext;return L.set(e,t),this.contexts.push(t),t}static addAnalyzer(e,t){const s=t.createMediaElementSource(e),i=t.createAnalyser();return i.fftSize=256,i.minDecibels=-90,i.maxDecibels=-10,i.smoothingTimeConstant=.85,s.connect(i),i.connect(t.destination),_.set(e,s),T.set(e,i),this.analysers.push(i),i}static analyze(e){if(null!=e){const t=new Float32Array(e.fftSize);let s=0;e.getFloatTimeDomainData(t);for(const e of t)s+=e*e;return parseFloat(Math.sqrt(s/t.length*20).toFixed(1))}return parseFloat(Math.random().toFixed(1))}static dispose(e){var t,s;e.pause(),e.removeEventListener("ended",null==(t=I.get(e))?void 0:t.ended),e.removeEventListener("error",null==(s=I.get(e))?void 0:s.error),e.removeEventListener("canplaythrough",O.get(e)),I.delete(e),O.delete(e);const i=L.get(e);L.delete(e),null==i||i.close();const r=T.get(e);T.delete(e),null==r||r.disconnect();const o=_.get(e);_.delete(e),null==o||o.disconnect(),e.removeAttribute("src"),m(this.analysers,r),m(this.contexts,i),m(this.audios,e)}static destroy(){for(let e=this.contexts.length-1;e>=0;e--)this.contexts[e].close();for(let e=this.audios.length-1;e>=0;e--)this.dispose(this.audios[e])}}o(F,"audios",[]),o(F,"analysers",[]),o(F,"contexts",[]),o(F,"_volume",w);var A="object"==typeof global&&global&&global.Object===Object&&global,R="object"==typeof self&&self&&self.Object===Object&&self,j=A||R||Function("return this")(),D=j.Symbol,S=Object.prototype,k=S.hasOwnProperty,C=S.toString,U=D?D.toStringTag:void 0;var G=Object.prototype.toString;var N=D?D.toStringTag:void 0;function H(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":N&&N in Object(e)?function(e){var t=k.call(e,U),s=e[U];try{e[U]=void 0;var i=!0}catch(o){}var r=C.call(e);return i&&(t?e[U]=s:delete e[U]),r}(e):function(e){return G.call(e)}(e)}function X(e){return null!=e&&"object"==typeof e}var W=Array.isArray;function $(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function B(e){if(!$(e))return!1;var t=H(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}var V,q=j["__core-js_shared__"],Y=(V=/[^.]+$/.exec(q&&q.keys&&q.keys.IE_PROTO||""))?"Symbol(src)_1."+V:"";var z=Function.prototype.toString;function J(e){if(null!=e){try{return z.call(e)}catch(t){}try{return e+""}catch(t){}}return""}var Z=/^\[object .+?Constructor\]$/,Q=Function.prototype,K=Object.prototype,ee=Q.toString,te=K.hasOwnProperty,se=RegExp("^"+ee.call(te).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function ie(e){return!(!$(e)||(t=e,Y&&Y in t))&&(B(e)?se:Z).test(J(e));var t}function re(e,t){var s=function(e,t){return null==e?void 0:e[t]}(e,t);return ie(s)?s:void 0}var oe=re(j,"WeakMap");function ne(){}function ae(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}var le=Object.prototype;function de(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||le)}function he(e){return X(e)&&"[object Arguments]"==H(e)}var ue=Object.prototype,ce=ue.hasOwnProperty,pe=ue.propertyIsEnumerable,ge=he(function(){return arguments}())?he:function(e){return X(e)&&ce.call(e,"callee")&&!pe.call(e,"callee")};var fe="object"==typeof e&&e&&!e.nodeType&&e,me=fe&&"object"==typeof module&&module&&!module.nodeType&&module,ye=me&&me.exports===fe?j.Buffer:void 0,xe=(ye?ye.isBuffer:void 0)||function(){return!1},ve={};ve["[object Float32Array]"]=ve["[object Float64Array]"]=ve["[object Int8Array]"]=ve["[object Int16Array]"]=ve["[object Int32Array]"]=ve["[object Uint8Array]"]=ve["[object Uint8ClampedArray]"]=ve["[object Uint16Array]"]=ve["[object Uint32Array]"]=!0,ve["[object Arguments]"]=ve["[object Array]"]=ve["[object ArrayBuffer]"]=ve["[object Boolean]"]=ve["[object DataView]"]=ve["[object Date]"]=ve["[object Error]"]=ve["[object Function]"]=ve["[object Map]"]=ve["[object Number]"]=ve["[object Object]"]=ve["[object RegExp]"]=ve["[object Set]"]=ve["[object String]"]=ve["[object WeakMap]"]=!1;var Me,Ee="object"==typeof e&&e&&!e.nodeType&&e,be=Ee&&"object"==typeof module&&module&&!module.nodeType&&module,Pe=be&&be.exports===Ee&&A.process,we=function(){try{var e=be&&be.require&&be.require("util").types;return e||Pe&&Pe.binding&&Pe.binding("util")}catch(t){}}(),Ie=we&&we.isTypedArray,Oe=Ie?(Me=Ie,function(e){return Me(e)}):function(e){return X(e)&&ae(e.length)&&!!ve[H(e)]};var Le=function(e,t){return function(s){return e(t(s))}}(Object.keys,Object),Te=Object.prototype.hasOwnProperty;var _e=re(j,"Map"),Fe=re(j,"DataView"),Ae=re(j,"Promise"),Re=re(j,"Set"),je="[object Map]",De="[object Promise]",Se="[object Set]",ke="[object WeakMap]",Ce="[object DataView]",Ue=J(Fe),Ge=J(_e),Ne=J(Ae),He=J(Re),Xe=J(oe),We=H;(Fe&&We(new Fe(new ArrayBuffer(1)))!=Ce||_e&&We(new _e)!=je||Ae&&We(Ae.resolve())!=De||Re&&We(new Re)!=Se||oe&&We(new oe)!=ke)&&(We=function(e){var t=H(e),s="[object Object]"==t?e.constructor:void 0,i=s?J(s):"";if(i)switch(i){case Ue:return Ce;case Ge:return je;case Ne:return De;case He:return Se;case Xe:return ke}return t});var $e=Object.prototype.hasOwnProperty;function Be(e){if(null==e)return!0;if(function(e){return null!=e&&ae(e.length)&&!B(e)}(e)&&(W(e)||"string"==typeof e||"function"==typeof e.splice||xe(e)||Oe(e)||ge(e)))return!e.length;var t=We(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(de(e))return!function(e){if(!de(e))return Le(e);var t=[];for(var s in Object(e))Te.call(e,s)&&"constructor"!=s&&t.push(s);return t}(e).length;for(var s in e)if($e.call(e,s))return!1;return!0}var Ve=(e=>(e.ALL="ALL",e.IDLE="IDLE",e.NONE="NONE",e))(Ve||{});class qe extends t.utils.EventEmitter{constructor(e,t){super(),o(this,"tag"),o(this,"settings"),o(this,"motionGroups",{}),o(this,"state",new P),o(this,"currentAudio"),o(this,"currentAnalyzer"),o(this,"currentContext"),o(this,"playing",!1),o(this,"destroyed",!1),this.settings=e,this.tag=`MotionManager(${e.name})`,this.state.tag=this.tag}init(e){(null==e?void 0:e.idleMotionGroup)&&(this.groups.idle=e.idleMotionGroup),this.setupMotions(e),this.stopAllMotions()}setupMotions(e){for(const s of Object.keys(this.definitions))this.motionGroups[s]=[];let t;switch(null==e?void 0:e.motionPreload){case"NONE":return;case"ALL":t=Object.keys(this.definitions);break;default:t=[this.groups.idle]}for(const s of t)if(this.definitions[s])for(let e=0;e<this.definitions[s].length;e++)this.loadMotion(s,e).then()}loadMotion(e,t){return n(this,null,(function*(){var s;if(!(null==(s=this.definitions[e])?void 0:s[t]))return void h.warn(this.tag,`Undefined motion at "${e}"[${t}]`);if(null===this.motionGroups[e][t])return void h.warn(this.tag,`Cannot start motion at "${e}"[${t}] because it's already failed in loading.`);if(this.motionGroups[e][t])return this.motionGroups[e][t];const i=yield this._loadMotion(e,t);return this.destroyed?void 0:(this.motionGroups[e][t]=null!=i?i:null,i)}))}_loadMotion(e,t){throw new Error("Not implemented.")}speak(e){return n(this,arguments,(function*(e,{volume:t=.5,expression:s,resetExpression:i=!0,crossOrigin:r,onFinish:o,onError:n}={}){if(!d.sound)return!1;let a,l,u,c;if(this.currentAudio&&!this.currentAudio.ended)return!1;const p=e&&e.startsWith("data:");if(e&&!p){const t=document.createElement("a");t.href=e,c=e=t.href}else c="data:audio/";const g=e;if(g)try{a=F.add(g,((e=this)=>{console.log("Audio finished playing"),null==o||o(),i&&s&&e.expressionManager&&e.expressionManager.resetExpression(),e.currentAudio=void 0}),((e,t=this)=>{console.log("Error during audio playback:",e),null==n||n(e),i&&s&&t.expressionManager&&t.expressionManager.resetExpression(),t.currentAudio=void 0}),r),this.currentAudio=a,F.volume=t,u=F.addContext(this.currentAudio),this.currentContext=u,l=F.addAnalyzer(this.currentAudio,this.currentContext),this.currentAnalyzer=l}catch(f){return h.warn(this.tag,"Failed to create audio",c,f),!1}if(a){let e=!0;const t=F.play(a).catch((t=>{h.warn(this.tag,"Failed to play audio",a.src,t),e=!1}));if(d.motionSync&&(yield t,!e))return!1}return this.state.shouldOverrideExpression()&&this.expressionManager&&this.expressionManager.resetExpression(),s&&this.expressionManager&&this.expressionManager.setExpression(s),this.playing=!0,!0}))}startMotion(e,t){return n(this,arguments,(function*(e,t,s=b.NORMAL,{sound:i,volume:r=.5,expression:o,resetExpression:n=!0,crossOrigin:a,onFinish:l,onError:u}={}){var c;if(!this.state.reserve(e,t,s))return!1;if(this.currentAudio&&!this.currentAudio.ended&&s!=b.FORCE)return!1;const p=null==(c=this.definitions[e])?void 0:c[t];if(!p)return!1;let g,f,m,y;this.currentAudio&&F.dispose(this.currentAudio);const x=i&&i.startsWith("data:");if(i&&!x){const e=document.createElement("a");e.href=i,y=i=e.href}else y=this.getSoundFile(p),y&&(y=this.settings.resolveURL(y));const v=y;if(v)try{g=F.add(v,((e=this)=>{console.log("Audio finished playing"),null==l||l(),n&&o&&e.expressionManager&&e.expressionManager.resetExpression(),e.currentAudio=void 0}),((e,t=this)=>{console.log("Error during audio playback:",e),null==u||u(e),n&&o&&t.expressionManager&&t.expressionManager.resetExpression(),t.currentAudio=void 0}),a),this.currentAudio=g,F.volume=r,m=F.addContext(this.currentAudio),this.currentContext=m,f=F.addAnalyzer(this.currentAudio,this.currentContext),this.currentAnalyzer=f}catch(E){h.warn(this.tag,"Failed to create audio",y,E)}const M=yield this.loadMotion(e,t);if(g&&!Be(g.src)){const e=F.play(g).catch((e=>h.warn(this.tag,"Failed to play audio",g.src,e)));d.motionSync&&(yield e)}return this.state.start(M,e,t,s)?(this.state.shouldOverrideExpression()&&this.expressionManager&&this.expressionManager.resetExpression(),h.log(this.tag,"Start motion:",this.getMotionName(p)),this.emit("motionStart",e,t,g),o&&this.expressionManager&&this.state.shouldOverrideExpression()&&this.expressionManager.setExpression(o),this.playing=!0,this._startMotion(M),!0):(g&&!Be(g.src)&&(F.dispose(g),this.currentAudio=void 0),!1)}))}startRandomMotion(e,t){return n(this,arguments,(function*(e,t,{sound:s,volume:i=.5,expression:r,resetExpression:o=!0,crossOrigin:n,onFinish:a,onError:l}={}){const d=this.definitions[e];if(null==d?void 0:d.length){const h=[];for(let t=0;t<d.length;t++)null===this.motionGroups[e][t]||this.state.isActive(e,t)||h.push(t);if(h.length){const d=h[Math.floor(Math.random()*h.length)];return this.startMotion(e,d,t,{sound:s,volume:i,expression:r,resetExpression:o,crossOrigin:n,onFinish:a,onError:l})}}return!1}))}stopSpeaking(){this.currentAudio&&(F.dispose(this.currentAudio),this.currentAudio=void 0)}stopAllMotions(){this._stopAllMotions(),this.state.reset(),this.stopSpeaking()}update(e,t){var s;return this.isFinished()&&(this.playing&&(this.playing=!1,this.emit("motionFinish")),this.state.shouldOverrideExpression()&&(null==(s=this.expressionManager)||s.restoreExpression()),this.state.complete(),this.state.shouldRequestIdleMotion()&&this.startRandomMotion(this.groups.idle,b.IDLE)),this.updateParameters(e,t)}mouthSync(){return this.currentAnalyzer?F.analyze(this.currentAnalyzer):0}destroy(){var e;this.destroyed=!0,this.emit("destroy"),this.stopAllMotions(),null==(e=this.expressionManager)||e.destroy();this.definitions=void 0,this.motionGroups=void 0}}const Ye={x:0,y:0,width:0,height:0};class ze extends t.utils.EventEmitter{constructor(){super(...arguments),o(this,"focusController",new M),o(this,"pose"),o(this,"physics"),o(this,"originalWidth",0),o(this,"originalHeight",0),o(this,"width",0),o(this,"height",0),o(this,"localTransform",new t.Matrix),o(this,"drawingMatrix",new t.Matrix),o(this,"hitAreas",{}),o(this,"textureFlipY",!1),o(this,"viewport",[0,0,0,0]),o(this,"destroyed",!1)}init(){this.setupLayout(),this.setupHitAreas()}setupLayout(){const e=this,t=this.getSize();e.originalWidth=t[0],e.originalHeight=t[1];const s=Object.assign({width:2,height:2},this.getLayout());this.localTransform.scale(s.width/2,s.height/2),e.width=this.originalWidth*this.localTransform.a,e.height=this.originalHeight*this.localTransform.d;const i=void 0!==s.x&&s.x-s.width/2||void 0!==s.centerX&&s.centerX||void 0!==s.left&&s.left-s.width/2||void 0!==s.right&&s.right+s.width/2||0,r=void 0!==s.y&&s.y-s.height/2||void 0!==s.centerY&&s.centerY||void 0!==s.top&&s.top-s.height/2||void 0!==s.bottom&&s.bottom+s.height/2||0;this.localTransform.translate(this.width*i,-this.height*r)}setupHitAreas(){const e=this.getHitAreaDefs().filter((e=>e.index>=0));for(const t of e)this.hitAreas[t.name]=t}hitTest(e,t){return Object.keys(this.hitAreas).filter((s=>this.isHit(s,e,t)))}isHit(e,t,s){if(!this.hitAreas[e])return!1;const i=this.hitAreas[e].index,r=this.getDrawableBounds(i,Ye);return r.x<=t&&t<=r.x+r.width&&r.y<=s&&s<=r.y+r.height}getDrawableBounds(e,t){const s=this.getDrawableVertices(e);let i=s[0],r=s[0],o=s[1],n=s[1];for(let a=0;a<s.length;a+=2){const e=s[a],t=s[a+1];i=Math.min(e,i),r=Math.max(e,r),o=Math.min(t,o),n=Math.max(t,n)}return null!=t||(t={}),t.x=i,t.y=o,t.width=r-i,t.height=n-o,t}updateTransform(e){this.drawingMatrix.copyFrom(e).append(this.localTransform)}update(e,t){this.focusController.update(e)}destroy(){this.destroyed=!0,this.emit("destroy"),this.motionManager.destroy(),this.motionManager=void 0}}class Je extends Error{constructor(e,t,s,i=!1){super(e),this.url=t,this.status=s,this.aborted=i}}const Ze=class e{static createXHR(t,s,i,r,o){const n=new XMLHttpRequest;if(e.allXhrSet.add(n),t){let s=e.xhrMap.get(t);s?s.add(n):(s=new Set([n]),e.xhrMap.set(t,s)),t.listeners("destroy").includes(e.cancelXHRs)||t.once("destroy",e.cancelXHRs)}return n.open("GET",s),n.responseType=i,n.onload=()=>{200!==n.status&&0!==n.status||!n.response?n.onerror():r(n.response)},n.onerror=()=>{h.warn("XHRLoader",`Failed to load resource as ${n.responseType} (Status ${n.status}): ${s}`),o(new Je("Network error.",s,n.status))},n.onabort=()=>o(new Je("Aborted.",s,n.status,!0)),n.onloadend=()=>{var s;e.allXhrSet.delete(n),t&&(null==(s=e.xhrMap.get(t))||s.delete(n))},n}static cancelXHRs(){var t;null==(t=e.xhrMap.get(this))||t.forEach((t=>{t.abort(),e.allXhrSet.delete(t)})),e.xhrMap.delete(this)}static release(){e.allXhrSet.forEach((e=>e.abort())),e.allXhrSet.clear(),e.xhrMap=new WeakMap}};o(Ze,"xhrMap",new WeakMap),o(Ze,"allXhrSet",new Set),o(Ze,"loader",((e,t)=>new Promise(((t,s)=>{Ze.createXHR(e.target,e.settings?e.settings.resolveURL(e.url):e.url,e.type,(s=>{e.result=s,t()}),s).send()}))));let Qe=Ze;function Ke(e,t){let s=-1;return function i(r,o){if(o)return Promise.reject(o);if(r<=s)return Promise.reject(new Error("next() called multiple times"));s=r;const n=e[r];if(!n)return Promise.resolve();try{return Promise.resolve(n(t,i.bind(null,r+1)))}catch(a){return Promise.reject(a)}}(0)}class et{static load(e){return Ke(this.middlewares,e).then((()=>e.result))}}o(et,"middlewares",[Qe.loader]);const tt="Live2DFactory",st=(e,t)=>n(this,null,(function*(){if("string"==typeof e.source){const t=yield et.load({url:e.source,type:"json",target:e.live2dModel});t.url=e.source,e.source=t,e.live2dModel.emit("settingsJSONLoaded",t)}return t()})),it=(e,t)=>n(this,null,(function*(){if(e.source instanceof E)return e.settings=e.source,t();if("object"==typeof e.source){const s=pt.findRuntime(e.source);if(s){const i=s.createModelSettings(e.source);return e.settings=i,e.live2dModel.emit("settingsLoaded",i),t()}}throw new TypeError("Unknown settings format.")})),rt=(e,t)=>{if(e.settings){const s=pt.findRuntime(e.settings);if(s)return s.ready().then(t)}return t()},ot=(e,t)=>n(this,null,(function*(){yield t();const s=e.internalModel;if(s){const t=e.settings,i=pt.findRuntime(t);if(i){const r=[];t.pose&&r.push(et.load({settings:t,url:t.pose,type:"json",target:s}).then((t=>{s.pose=i.createPose(s.coreModel,t),e.live2dModel.emit("poseLoaded",s.pose)})).catch((t=>{e.live2dModel.emit("poseLoadError",t),h.warn(tt,"Failed to load pose.",t)}))),t.physics&&r.push(et.load({settings:t,url:t.physics,type:"json",target:s}).then((t=>{s.physics=i.createPhysics(s.coreModel,t),e.live2dModel.emit("physicsLoaded",s.physics)})).catch((t=>{e.live2dModel.emit("physicsLoadError",t),h.warn(tt,"Failed to load physics.",t)}))),r.length&&(yield Promise.all(r))}}})),nt=(e,s)=>n(this,null,(function*(){if(!e.settings)throw new TypeError("Missing settings.");{const i=e.live2dModel,r=Promise.all(e.settings.textures.map((s=>function(e,s={}){const i={resourceOptions:{crossorigin:s.crossOrigin}};if(t.Texture.fromURL)return t.Texture.fromURL(e,i).catch((e=>{if(e instanceof Error)throw e;const t=new Error("Texture loading error");throw t.event=e,t}));i.resourceOptions.autoLoad=!1;const r=t.Texture.from(e,i);if(r.baseTexture.valid)return Promise.resolve(r);const o=r.baseTexture.resource;return null!=o._live2d_load||(o._live2d_load=new Promise(((e,t)=>{const s=e=>{o.source.removeEventListener("error",s);const i=new Error("Texture loading error");i.event=e,t(i)};o.source.addEventListener("error",s),o.load().then((()=>e(r))).catch(s)}))),o._live2d_load}(e.settings.resolveURL(s),{crossOrigin:e.options.crossOrigin}))));if(r.catch(ne),yield s(),!e.internalModel)throw new TypeError("Missing internal model.");i.internalModel=e.internalModel,i.emit("modelLoaded",e.internalModel),i.textures=yield r,i.emit("textureLoaded",i.textures)}})),at=(e,t)=>n(this,null,(function*(){const s=e.settings;if(s instanceof E){const i=pt.findRuntime(s);if(!i)throw new TypeError("Unknown model settings.");const r=yield et.load({settings:s,url:s.moc,type:"arraybuffer",target:e.live2dModel});if(!i.isValidMoc(r))throw new Error("Invalid moc data");const o=i.createCoreModel(r);return e.internalModel=i.createInternalModel(o,s,e.options),t()}throw new TypeError("Missing settings.")})),lt=class e{static unzip(s,i){return n(this,null,(function*(){const r=yield e.getFilePaths(s),o=[];for(const e of i.getDefinedFiles()){const s=decodeURI(t.utils.url.resolve(i.url,e));r.includes(s)&&o.push(s)}const n=yield e.getFiles(s,o);for(let e=0;e<n.length;e++){const t=o[e],s=n[e];Object.defineProperty(s,"webkitRelativePath",{value:t})}return n}))}static createSettings(t){return n(this,null,(function*(){const s=(yield e.getFilePaths(t)).find((e=>e.endsWith("model.json")||e.endsWith("model3.json")));if(!s)throw new Error("Settings file not found");const i=yield e.readText(t,s);if(!i)throw new Error("Empty settings file: "+s);const r=JSON.parse(i);r.url=s;const o=e.live2dFactory.findRuntime(r);if(!o)throw new Error("Unknown settings JSON");return o.createModelSettings(r)}))}static zipReader(e,t){return n(this,null,(function*(){throw new Error("Not implemented")}))}static getFilePaths(e){return n(this,null,(function*(){throw new Error("Not implemented")}))}static getFiles(e,t){return n(this,null,(function*(){throw new Error("Not implemented")}))}static readText(e,t){return n(this,null,(function*(){throw new Error("Not implemented")}))}static releaseReader(e){}};o(lt,"live2dFactory"),o(lt,"ZIP_PROTOCOL","zip://"),o(lt,"uid",0),o(lt,"factory",((e,t)=>n(lt,null,(function*(){const s=e.source;let i,r,o;if("string"==typeof s&&(s.endsWith(".zip")||s.startsWith(lt.ZIP_PROTOCOL))?(i=s.startsWith(lt.ZIP_PROTOCOL)?s.slice(lt.ZIP_PROTOCOL.length):s,r=yield et.load({url:i,type:"blob",target:e.live2dModel})):Array.isArray(s)&&1===s.length&&s[0]instanceof File&&s[0].name.endsWith(".zip")&&(r=s[0],i=URL.createObjectURL(r),o=s.settings),r){if(!r.size)throw new Error("Empty zip file");const t=yield lt.zipReader(r,i);o||(o=yield lt.createSettings(t)),o._objectURL=lt.ZIP_PROTOCOL+lt.uid+"/"+o.url;const s=yield lt.unzip(t,o);s.settings=o,e.source=s,i.startsWith("blob:")&&e.live2dModel.once("modelLoaded",(e=>{e.once("destroy",(function(){URL.revokeObjectURL(i)}))})),lt.releaseReader(t)}return t()}))));let dt=lt;const ht=class e{static resolveURL(t,s){var i;const r=null==(i=e.filesMap[t])?void 0:i[s];if(void 0===r)throw new Error("Cannot find this file from uploaded files: "+s);return r}static upload(s,i){return n(this,null,(function*(){const r={};for(const e of i.getDefinedFiles()){const o=decodeURI(t.utils.url.resolve(i.url,e)),n=s.find((e=>e.webkitRelativePath===o));n&&(r[e]=URL.createObjectURL(n))}e.filesMap[i._objectURL]=r}))}static createSettings(t){return n(this,null,(function*(){const s=t.find((e=>e.name.endsWith("model.json")||e.name.endsWith("model3.json")));if(!s)throw new TypeError("Settings file not found");const i=yield e.readText(s),r=JSON.parse(i);r.url=s.webkitRelativePath;const o=pt.findRuntime(r);if(!o)throw new Error("Unknown settings JSON");const n=o.createModelSettings(r);return n._objectURL=URL.createObjectURL(s),n}))}static readText(e){return n(this,null,(function*(){return new Promise(((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=s,i.readAsText(e,"utf8")}))}))}};o(ht,"live2dFactory"),o(ht,"filesMap",{}),o(ht,"factory",((e,t)=>n(ht,null,(function*(){if(Array.isArray(e.source)&&e.source[0]instanceof File){const t=e.source;let s=t.settings;if(s){if(!s._objectURL)throw new Error('"_objectURL" must be specified in ModelSettings')}else s=yield ht.createSettings(t);s.validateFiles(t.map((e=>encodeURI(e.webkitRelativePath)))),yield ht.upload(t,s),s.resolveURL=function(e){return ht.resolveURL(this._objectURL,e)},e.source=s,e.live2dModel.once("modelLoaded",(e=>{e.once("destroy",(function(){const e=this.settings._objectURL;if(URL.revokeObjectURL(e),ht.filesMap[e])for(const t of Object.values(ht.filesMap[e]))URL.revokeObjectURL(t);delete ht.filesMap[e]}))}))}return t()}))));let ut=ht;const ct=class e{static registerRuntime(t){e.runtimes.push(t),e.runtimes.sort(((e,t)=>t.version-e.version))}static findRuntime(t){for(const s of e.runtimes)if(s.test(t))return s}static setupLive2DModel(t,s,i){return n(this,null,(function*(){const r=new Promise((e=>t.once("textureLoaded",e))),o=new Promise((e=>t.once("modelLoaded",e))),n=Promise.all([r,o]).then((()=>t.emit("ready")));yield Ke(e.live2DModelMiddlewares,{live2dModel:t,source:s,options:i||{}}),yield n,t.emit("load")}))}static loadMotion(t,s,i){var r;const o=e=>t.emit("motionLoadError",s,i,e);try{const n=null==(r=t.definitions[s])?void 0:r[i];if(!n)return Promise.resolve(void 0);t.listeners("destroy").includes(e.releaseTasks)||t.once("destroy",e.releaseTasks);let a=e.motionTasksMap.get(t);a||(a={},e.motionTasksMap.set(t,a));let l=a[s];l||(l=[],a[s]=l);const d=t.getMotionFile(n);return null!=l[i]||(l[i]=et.load({url:d,settings:t.settings,type:t.motionDataType,target:t}).then((r=>{var o;const a=null==(o=e.motionTasksMap.get(t))?void 0:o[s];a&&delete a[i];const l=t.createMotion(r,s,n);return t.emit("motionLoaded",s,i,l),l})).catch((e=>{h.warn(t.tag,`Failed to load motion: ${d}\n`,e),o(e)}))),l[i]}catch(n){h.warn(t.tag,`Failed to load motion at "${s}"[${i}]\n`,n),o(n)}return Promise.resolve(void 0)}static loadExpression(t,s){const i=e=>t.emit("expressionLoadError",s,e);try{const r=t.definitions[s];if(!r)return Promise.resolve(void 0);t.listeners("destroy").includes(e.releaseTasks)||t.once("destroy",e.releaseTasks);let o=e.expressionTasksMap.get(t);o||(o=[],e.expressionTasksMap.set(t,o));const n=t.getExpressionFile(r);return null!=o[s]||(o[s]=et.load({url:n,settings:t.settings,type:"json",target:t}).then((i=>{const o=e.expressionTasksMap.get(t);o&&delete o[s];const n=t.createExpression(i,r);return t.emit("expressionLoaded",s,n),n})).catch((e=>{h.warn(t.tag,`Failed to load expression: ${n}\n`,e),i(e)}))),o[s]}catch(r){h.warn(t.tag,`Failed to load expression at [${s}]\n`,r),i(r)}return Promise.resolve(void 0)}static releaseTasks(){this instanceof qe?e.motionTasksMap.delete(this):e.expressionTasksMap.delete(this)}};o(ct,"runtimes",[]),o(ct,"urlToJSON",st),o(ct,"jsonToSettings",it),o(ct,"waitUntilReady",rt),o(ct,"setupOptionals",ot),o(ct,"setupEssentials",nt),o(ct,"createInternalModel",at),o(ct,"live2DModelMiddlewares",[dt.factory,ut.factory,st,it,rt,ot,nt,at]),o(ct,"motionTasksMap",new WeakMap),o(ct,"expressionTasksMap",new WeakMap);let pt=ct;qe.prototype._loadMotion=function(e,t){return pt.loadMotion(this,e,t)},y.prototype._loadExpression=function(e){return pt.loadExpression(this,e)},ut.live2dFactory=pt,dt.live2dFactory=pt;const gt=class e{constructor(t,{autoUpdate:s=!0,autoHitTest:i=!0,autoFocus:r=!0,autoInteract:n,ticker:a}={}){o(this,"model"),o(this,"destroyed",!1),o(this,"_ticker"),o(this,"_autoUpdate",!1),o(this,"_autoHitTest",!1),o(this,"_autoFocus",!1),a||(e.defaultTicker?a=e.defaultTicker:"undefined"!=typeof PIXI&&(a=PIXI.Ticker.shared)),void 0!==n&&(i=n,r=n,h.warn(t.tag,"options.autoInteract is deprecated since v0.5.0, use autoHitTest and autoFocus instead.")),this.model=t,this.ticker=a,this.autoUpdate=s,this.autoHitTest=i,this.autoFocus=r,(i||r)&&(this.model.eventMode="static")}get ticker(){return this._ticker}set ticker(e){var t;this._ticker&&this._ticker.remove(mt,this),this._ticker=e,this._autoUpdate&&(null==(t=this._ticker)||t.add(mt,this))}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){var t;this.destroyed||(e?this._ticker?(this._ticker.add(mt,this),this._autoUpdate=!0):h.warn(this.model.tag,"No Ticker to be used for automatic updates. Either set option.ticker when creating Live2DModel, or expose PIXI to global scope (window.PIXI = PIXI)."):(null==(t=this._ticker)||t.remove(mt,this),this._autoUpdate=!1))}get autoHitTest(){return this._autoHitTest}set autoHitTest(e){e!==this.autoHitTest&&(e?this.model.on("pointertap",yt,this):this.model.off("pointertap",yt,this),this._autoHitTest=e)}get autoFocus(){return this._autoFocus}set autoFocus(e){e!==this.autoFocus&&(e?this.model.on("globalpointermove",xt,this):this.model.off("globalpointermove",xt,this),this._autoFocus=e)}get autoInteract(){return this._autoHitTest&&this._autoFocus}set autoInteract(e){this.autoHitTest=e,this.autoFocus=e}onTickerUpdate(){const e=this.ticker.deltaMS;this.model.update(e)}onTap(e){this.model.tap(e.global.x,e.global.y)}onPointerMove(e){this.model.focus(e.global.x,e.global.y)}destroy(){this.autoFocus=!1,this.autoHitTest=!1,this.autoUpdate=!1,this.ticker=void 0,this.destroyed=!0}};o(gt,"defaultTicker");let ft=gt;function mt(){this.onTickerUpdate()}function yt(e){this.onTap(e)}function xt(e){this.onPointerMove(e)}class vt extends t.Transform{}const Mt=new t.Point,Et=new t.Matrix;class bt extends s.Container{constructor(e){super(),o(this,"tag","Live2DModel(uninitialized)"),o(this,"internalModel"),o(this,"textures",[]),o(this,"transform",new vt),o(this,"anchor",new t.ObservablePoint(this.onAnchorChange,this,0,0)),o(this,"glContextID",-1),o(this,"elapsedTime",0),o(this,"deltaTime",0),o(this,"automator"),this.automator=new ft(this,e),this.once("modelLoaded",(()=>this.init(e)))}static from(e,t){const s=new this(t);return pt.setupLive2DModel(s,e,t).then((()=>s))}static fromSync(e,t){const s=new this(t);return pt.setupLive2DModel(s,e,t).then(null==t?void 0:t.onLoad).catch(null==t?void 0:t.onError),s}static registerTicker(e){ft.defaultTicker=e.shared}init(e){this.tag=`Live2DModel(${this.internalModel.settings.name})`}onAnchorChange(){this.pivot.set(this.anchor.x*this.internalModel.width,this.anchor.y*this.internalModel.height)}motion(e,t,s,{sound:i,volume:r=.5,expression:o,resetExpression:n=!0,crossOrigin:a,onFinish:l,onError:d}={}){return void 0===t?this.internalModel.motionManager.startRandomMotion(e,s,{sound:i,volume:r,expression:o,resetExpression:n,crossOrigin:a,onFinish:l,onError:d}):this.internalModel.motionManager.startMotion(e,t,s,{sound:i,volume:r,expression:o,resetExpression:n,crossOrigin:a,onFinish:l,onError:d})}stopMotions(){return this.internalModel.motionManager.stopAllMotions()}speak(e,{volume:t=.5,expression:s,resetExpression:i=!0,crossOrigin:r,onFinish:o,onError:n}={}){return this.internalModel.motionManager.speak(e,{volume:t,expression:s,resetExpression:i,crossOrigin:r,onFinish:o,onError:n})}stopSpeaking(){return this.internalModel.motionManager.stopSpeaking()}expression(e){return this.internalModel.motionManager.expressionManager?void 0===e?this.internalModel.motionManager.expressionManager.setRandomExpression():this.internalModel.motionManager.expressionManager.setExpression(e):Promise.resolve(!1)}focus(e,t,s=!1){Mt.x=e,Mt.y=t,this.toModelPosition(Mt,Mt,!0);const i=Mt.x/this.internalModel.originalWidth*2-1,r=Mt.y/this.internalModel.originalHeight*2-1,o=Math.atan2(r,i);this.internalModel.focusController.focus(Math.cos(o),-Math.sin(o),s)}tap(e,t){const s=this.hitTest(e,t);s.length&&(h.log(this.tag,"Hit",s),this.emit("hit",s))}hitTest(e,t){return Mt.x=e,Mt.y=t,this.toModelPosition(Mt,Mt),this.internalModel.hitTest(Mt.x,Mt.y)}toModelPosition(e,t=e.clone(),s){return s||(this._recursivePostUpdateTransform(),this.parent?this.displayObjectUpdateTransform():(this.parent=this._tempDisplayObjectParent,this.displayObjectUpdateTransform(),this.parent=null)),this.transform.worldTransform.applyInverse(e,t),this.internalModel.localTransform.applyInverse(t,t),t}containsPoint(e){return this.getBounds(!0).contains(e.x,e.y)}_calculateBounds(){this._bounds.addFrame(this.transform,0,0,this.internalModel.width,this.internalModel.height)}update(e){this.deltaTime+=e,this.elapsedTime+=e}_render(e){e.batch.reset(),e.geometry.reset(),e.shader.reset(),e.state.reset();let t=!1;this.glContextID!==e.CONTEXT_UID&&(this.glContextID=e.CONTEXT_UID,this.internalModel.updateWebGLContext(e.gl,this.glContextID),t=!0);for(let r=0;r<this.textures.length;r++){const s=this.textures[r];s.valid&&(!t&&s.baseTexture._glTextures[this.glContextID]||(e.gl.pixelStorei(WebGLRenderingContext.UNPACK_FLIP_Y_WEBGL,this.internalModel.textureFlipY),e.texture.bind(s.baseTexture,0)),this.internalModel.bindTexture(r,s.baseTexture._glTextures[this.glContextID].texture),s.baseTexture.touched=e.textureGC.count)}const s=e.framebuffer.viewport;this.internalModel.viewport=[s.x,s.y,s.width,s.height],this.deltaTime&&(this.internalModel.update(this.deltaTime,this.elapsedTime),this.deltaTime=0);const i=Et.copyFrom(e.globalUniforms.uniforms.projectionMatrix).append(this.worldTransform);this.internalModel.updateTransform(i),this.internalModel.draw(e.gl),e.state.reset(),e.texture.reset()}destroy(e){this.emit("destroy"),(null==e?void 0:e.texture)&&this.textures.forEach((t=>t.destroy(e.baseTexture))),this.automator.destroy(),this.internalModel.destroy(),super.destroy(e)}}if(!window.Live2D)throw new Error("Could not find Cubism 2 runtime. This plugin requires live2d.min.js to be loaded.");const Pt=Live2DMotion.prototype.updateParam;Live2DMotion.prototype.updateParam=function(e,t){Pt.call(this,e,t),t.isFinished()&&this.onFinishHandler&&(this.onFinishHandler(this),delete this.onFinishHandler)};class wt extends AMotion{constructor(e){super(),o(this,"params",[]),this.setFadeIn(e.fade_in>0?e.fade_in:d.expressionFadingDuration),this.setFadeOut(e.fade_out>0?e.fade_out:d.expressionFadingDuration),Array.isArray(e.params)&&e.params.forEach((e=>{const t=e.calc||"add";if("add"===t){const t=e.def||0;e.val-=t}else if("mult"===t){const t=e.def||1;e.val/=t}this.params.push({calc:t,val:e.val,id:e.id})}))}updateParamExe(e,t,s,i){this.params.forEach((t=>{e.setParamFloat(t.id,t.val*s)}))}}class It extends y{constructor(e,t){var s;super(e,t),o(this,"queueManager",new MotionQueueManager),o(this,"definitions"),this.definitions=null!=(s=this.settings.expressions)?s:[],this.init()}isFinished(){return this.queueManager.isFinished()}getExpressionIndex(e){return this.definitions.findIndex((t=>t.name===e))}getExpressionFile(e){return e.file}createExpression(e,t){return new wt(e)}_setExpression(e){return this.queueManager.startMotion(e)}stopAllExpressions(){this.queueManager.stopAllMotions()}updateParameters(e,t){return this.queueManager.updateParam(e)}}class Ot extends qe{constructor(e,t){super(e,t),o(this,"definitions"),o(this,"groups",{idle:"idle"}),o(this,"motionDataType","arraybuffer"),o(this,"queueManager",new MotionQueueManager),o(this,"lipSyncIds"),o(this,"expressionManager"),this.definitions=this.settings.motions,this.init(t),this.lipSyncIds=["PARAM_MOUTH_OPEN_Y"]}init(e){super.init(e),this.settings.expressions&&(this.expressionManager=new It(this.settings,e))}isFinished(){return this.queueManager.isFinished()}createMotion(e,t,s){const i=Live2DMotion.loadMotion(e),r=t===this.groups.idle?d.idleMotionFadingDuration:d.motionFadingDuration;return i.setFadeIn(s.fade_in>0?s.fade_in:r),i.setFadeOut(s.fade_out>0?s.fade_out:r),i}getMotionFile(e){return e.file}getMotionName(e){return e.file}getSoundFile(e){return e.sound}_startMotion(e,t){return e.onFinishHandler=t,this.queueManager.stopAllMotions(),this.queueManager.startMotion(e)}_stopAllMotions(){this.queueManager.stopAllMotions()}updateParameters(e,t){return this.queueManager.updateParam(e)}destroy(){super.destroy(),this.queueManager=void 0}}class Lt{constructor(e){o(this,"leftParam"),o(this,"rightParam"),o(this,"blinkInterval",4e3),o(this,"closingDuration",100),o(this,"closedDuration",50),o(this,"openingDuration",150),o(this,"eyeState",0),o(this,"eyeParamValue",1),o(this,"closedTimer",0),o(this,"nextBlinkTimeLeft",this.blinkInterval),this.coreModel=e,this.leftParam=e.getParamIndex("PARAM_EYE_L_OPEN"),this.rightParam=e.getParamIndex("PARAM_EYE_R_OPEN")}setEyeParams(e){this.eyeParamValue=u(e,0,1),this.coreModel.setParamFloat(this.leftParam,this.eyeParamValue),this.coreModel.setParamFloat(this.rightParam,this.eyeParamValue)}update(e){switch(this.eyeState){case 0:this.nextBlinkTimeLeft-=e,this.nextBlinkTimeLeft<0&&(this.eyeState=1,this.nextBlinkTimeLeft=this.blinkInterval+this.closingDuration+this.closedDuration+this.openingDuration+c(0,2e3));break;case 1:this.setEyeParams(this.eyeParamValue+e/this.closingDuration),this.eyeParamValue<=0&&(this.eyeState=2,this.closedTimer=0);break;case 2:this.closedTimer+=e,this.closedTimer>=this.closedDuration&&(this.eyeState=3);break;case 3:this.setEyeParams(this.eyeParamValue+e/this.openingDuration),this.eyeParamValue>=1&&(this.eyeState=0)}}}const Tt=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class _t extends ze{constructor(e,t,s){super(),o(this,"settings"),o(this,"coreModel"),o(this,"motionManager"),o(this,"eyeBlink"),o(this,"eyeballXParamIndex"),o(this,"eyeballYParamIndex"),o(this,"angleXParamIndex"),o(this,"angleYParamIndex"),o(this,"angleZParamIndex"),o(this,"bodyAngleXParamIndex"),o(this,"breathParamIndex"),o(this,"textureFlipY",!0),o(this,"lipSync",!0),o(this,"drawDataCount",0),o(this,"disableCulling",!1),o(this,"hasDrawn",!1),this.coreModel=e,this.settings=t,this.motionManager=new Ot(t,s),this.eyeBlink=new Lt(e),this.eyeballXParamIndex=e.getParamIndex("PARAM_EYE_BALL_X"),this.eyeballYParamIndex=e.getParamIndex("PARAM_EYE_BALL_Y"),this.angleXParamIndex=e.getParamIndex("PARAM_ANGLE_X"),this.angleYParamIndex=e.getParamIndex("PARAM_ANGLE_Y"),this.angleZParamIndex=e.getParamIndex("PARAM_ANGLE_Z"),this.bodyAngleXParamIndex=e.getParamIndex("PARAM_BODY_ANGLE_X"),this.breathParamIndex=e.getParamIndex("PARAM_BREATH"),this.init()}init(){super.init(),this.settings.initParams&&this.settings.initParams.forEach((({id:e,value:t})=>this.coreModel.setParamFloat(e,t))),this.settings.initOpacities&&this.settings.initOpacities.forEach((({id:e,value:t})=>this.coreModel.setPartsOpacity(e,t))),this.coreModel.saveParam();const e=this.coreModel.getModelContext()._$aS;(null==e?void 0:e.length)&&(this.drawDataCount=e.length);let t=this.coreModel.drawParamWebGL.culling;Object.defineProperty(this.coreModel.drawParamWebGL,"culling",{set:e=>t=e,get:()=>!this.disableCulling&&t});const s=this.coreModel.getModelContext().clipManager,i=s.setupClip;s.setupClip=(e,t)=>{i.call(s,e,t),t.gl.viewport(...this.viewport)}}getSize(){return[this.coreModel.getCanvasWidth(),this.coreModel.getCanvasHeight()]}getLayout(){const e={};if(this.settings.layout)for(const[t,s]of Object.entries(this.settings.layout)){let i=t;"center_x"===t?i="centerX":"center_y"===t&&(i="centerY"),e[i]=s}return e}updateWebGLContext(e,t){const s=this.coreModel.drawParamWebGL;s.firstDraw=!0,s.setGL(e),s.glno=t;for(const[o,n]of Object.entries(s))n instanceof WebGLBuffer&&(s[o]=null);const i=this.coreModel.getModelContext().clipManager;i.curFrameNo=t;const r=e.getParameter(e.FRAMEBUFFER_BINDING);i.getMaskRenderTexture(),e.bindFramebuffer(e.FRAMEBUFFER,r)}bindTexture(e,t){this.coreModel.setTexture(e,t)}getHitAreaDefs(){var e;return(null==(e=this.settings.hitAreas)?void 0:e.map((e=>({id:e.id,name:e.name,index:this.coreModel.getDrawDataIndex(e.id)}))))||[]}getDrawableIDs(){const e=this.coreModel.getModelContext(),t=[];for(let s=0;s<this.drawDataCount;s++){const i=e.getDrawData(s);i&&t.push(i.getDrawDataID().id)}return t}getDrawableIndex(e){return this.coreModel.getDrawDataIndex(e)}getDrawableVertices(e){if("string"==typeof e&&-1===(e=this.coreModel.getDrawDataIndex(e)))throw new TypeError("Unable to find drawable ID: "+e);return this.coreModel.getTransformedPoints(e).slice()}hitTest(e,t){return this.hasDrawn||h.warn("Trying to hit-test a Cubism 2 model that has not been rendered yet. The result will always be empty since the draw data is not ready."),super.hitTest(e,t)}update(e,t){var s,i,r,o;super.update(e,t);const n=this.coreModel;this.emit("beforeMotionUpdate");const a=this.motionManager.update(this.coreModel,t);if(this.emit("afterMotionUpdate"),n.saveParam(),null==(s=this.motionManager.expressionManager)||s.update(n,t),a||null==(i=this.eyeBlink)||i.update(e),this.updateFocus(),this.updateNaturalMovements(e,t),this.lipSync&&this.motionManager.currentAudio){let e=this.motionManager.mouthSync(),t=0;const s=1,i=1.2,r=.7;e>0&&(t=.4),e=Math.pow(e,r),e=u(e*i,t,s);for(let o=0;o<this.motionManager.lipSyncIds.length;++o)this.coreModel.setParamFloat(this.coreModel.getParamIndex(this.motionManager.lipSyncIds[o]),e)}null==(r=this.physics)||r.update(t),null==(o=this.pose)||o.update(e),this.emit("beforeModelUpdate"),n.update(),n.loadParam()}updateFocus(){this.coreModel.addToParamFloat(this.eyeballXParamIndex,this.focusController.x),this.coreModel.addToParamFloat(this.eyeballYParamIndex,this.focusController.y),this.coreModel.addToParamFloat(this.angleXParamIndex,30*this.focusController.x),this.coreModel.addToParamFloat(this.angleYParamIndex,30*this.focusController.y),this.coreModel.addToParamFloat(this.angleZParamIndex,this.focusController.x*this.focusController.y*-30),this.coreModel.addToParamFloat(this.bodyAngleXParamIndex,10*this.focusController.x)}updateNaturalMovements(e,t){const s=t/1e3*2*Math.PI;this.coreModel.addToParamFloat(this.angleXParamIndex,15*Math.sin(s/6.5345)*.5),this.coreModel.addToParamFloat(this.angleYParamIndex,8*Math.sin(s/3.5345)*.5),this.coreModel.addToParamFloat(this.angleZParamIndex,10*Math.sin(s/5.5345)*.5),this.coreModel.addToParamFloat(this.bodyAngleXParamIndex,4*Math.sin(s/15.5345)*.5),this.coreModel.setParamFloat(this.breathParamIndex,.5+.5*Math.sin(s/3.2345))}draw(e){const t=this.disableCulling;e.getParameter(e.FRAMEBUFFER_BINDING)&&(this.disableCulling=!0);const s=this.drawingMatrix;Tt[0]=s.a,Tt[1]=s.b,Tt[4]=s.c,Tt[5]=s.d,Tt[12]=s.tx,Tt[13]=s.ty,this.coreModel.setMatrix(Tt),this.coreModel.draw(),this.hasDrawn=!0,this.disableCulling=t}destroy(){super.destroy(),this.coreModel=void 0}}class Ft extends E{constructor(e){if(super(e),o(this,"moc"),o(this,"textures"),o(this,"layout"),o(this,"hitAreas"),o(this,"initParams"),o(this,"initOpacities"),o(this,"expressions"),o(this,"motions",{}),!Ft.isValidJSON(e))throw new TypeError("Invalid JSON.");this.moc=e.model,g("string",e,this,"textures","textures"),this.copy(e)}static isValidJSON(e){var t;return!!e&&"string"==typeof e.model&&(null==(t=e.textures)?void 0:t.length)>0&&e.textures.every((e=>"string"==typeof e))}copy(e){p("string",e,this,"name","name"),p("string",e,this,"pose","pose"),p("string",e,this,"physics","physics"),p("object",e,this,"layout","layout"),p("object",e,this,"motions","motions"),g("object",e,this,"hit_areas","hitAreas"),g("object",e,this,"expressions","expressions"),g("object",e,this,"init_params","initParams"),g("object",e,this,"init_opacities","initOpacities")}replaceFiles(e){super.replaceFiles(e);for(const[t,s]of Object.entries(this.motions))for(let i=0;i<s.length;i++)s[i].file=e(s[i].file,`motions.${t}[${i}].file`),void 0!==s[i].sound&&(s[i].sound=e(s[i].sound,`motions.${t}[${i}].sound`));if(this.expressions)for(let t=0;t<this.expressions.length;t++)this.expressions[t].file=e(this.expressions[t].file,`expressions[${t}].file`)}}const At={x:PhysicsHair.Src.SRC_TO_X,y:PhysicsHair.Src.SRC_TO_Y,angle:PhysicsHair.Src.SRC_TO_G_ANGLE},Rt={x:PhysicsHair.Src.SRC_TO_X,y:PhysicsHair.Src.SRC_TO_Y,angle:PhysicsHair.Src.SRC_TO_G_ANGLE};class jt{constructor(e,t){o(this,"physicsHairs",[]),this.coreModel=e,t.physics_hair&&(this.physicsHairs=t.physics_hair.map((e=>{const t=new PhysicsHair;return t.setup(e.setup.length,e.setup.regist,e.setup.mass),e.src.forEach((({id:e,ptype:s,scale:i,weight:r})=>{const o=At[s];o&&t.addSrcParam(o,e,i,r)})),e.targets.forEach((({id:e,ptype:s,scale:i,weight:r})=>{const o=Rt[s];o&&t.addTargetParam(o,e,i,r)})),t})))}update(e){this.physicsHairs.forEach((t=>t.update(this.coreModel,e)))}}class Dt{constructor(e){o(this,"paramIndex",-1),o(this,"partsIndex",-1),o(this,"link",[]),this.id=e}initIndex(e){this.paramIndex=e.getParamIndex("VISIBLE:"+this.id),this.partsIndex=e.getPartsDataIndex(PartsDataID.getID(this.id)),e.setParamFloat(this.paramIndex,1)}}class St{constructor(e,t){o(this,"opacityAnimDuration",500),o(this,"partsGroups",[]),this.coreModel=e,t.parts_visible&&(this.partsGroups=t.parts_visible.map((({group:e})=>e.map((({id:e,link:t})=>{const s=new Dt(e);return t&&(s.link=t.map((e=>new Dt(e)))),s})))),this.init())}init(){this.partsGroups.forEach((e=>{e.forEach((e=>{if(e.initIndex(this.coreModel),e.paramIndex>=0){const t=0!==this.coreModel.getParamFloat(e.paramIndex);this.coreModel.setPartsOpacity(e.partsIndex,t?1:0),this.coreModel.setParamFloat(e.paramIndex,t?1:0),e.link.length>0&&e.link.forEach((e=>e.initIndex(this.coreModel)))}}))}))}normalizePartsOpacityGroup(e,t){const s=this.coreModel,i=.5;let r=1,o=e.findIndex((({paramIndex:e,partsIndex:t})=>t>=0&&0!==s.getParamFloat(e)));if(o>=0){const i=s.getPartsOpacity(e[o].partsIndex);r=u(i+t/this.opacityAnimDuration,0,1)}else o=0,r=1;e.forEach((({partsIndex:e},t)=>{if(e>=0)if(o==t)s.setPartsOpacity(e,r);else{let t,o=s.getPartsOpacity(e);t=r<i?-.5*r/i+1:(1-r)*i/.5;(1-t)*(1-r)>.15&&(t=1-.15/(1-r)),o>t&&(o=t),s.setPartsOpacity(e,o)}}))}copyOpacity(e){const t=this.coreModel;e.forEach((({partsIndex:e,link:s})=>{if(e>=0&&s){const i=t.getPartsOpacity(e);s.forEach((({partsIndex:e})=>{e>=0&&t.setPartsOpacity(e,i)}))}}))}update(e){this.partsGroups.forEach((t=>{this.normalizePartsOpacityGroup(t,e),this.copyOpacity(t)}))}}pt.registerRuntime({version:2,test:e=>e instanceof Ft||Ft.isValidJSON(e),ready:()=>Promise.resolve(),isValidMoc(e){if(e.byteLength<3)return!1;const t=new Int8Array(e,0,3);return"moc"===String.fromCharCode(...t)},createModelSettings:e=>new Ft(e),createCoreModel(e){const t=Live2DModelWebGL.loadModel(e),s=Live2D.getError();if(s)throw s;return t},createInternalModel:(e,t,s)=>new _t(e,t,s),createPose:(e,t)=>new St(e,t),createPhysics:(e,t)=>new jt(e,t)}),e.Cubism2ExpressionManager=It,e.Cubism2InternalModel=_t,e.Cubism2ModelSettings=Ft,e.Cubism2MotionManager=Ot,e.ExpressionManager=y,e.FileLoader=ut,e.FocusController=M,e.InternalModel=ze,e.LOGICAL_HEIGHT=2,e.LOGICAL_WIDTH=2,e.Live2DExpression=wt,e.Live2DEyeBlink=Lt,e.Live2DFactory=pt,e.Live2DLoader=et,e.Live2DModel=bt,e.Live2DPhysics=jt,e.Live2DPose=St,e.Live2DTransform=vt,e.ModelSettings=E,e.MotionManager=qe,e.MotionPreloadStrategy=Ve,e.MotionPriority=b,e.MotionState=P,e.SoundManager=F,e.VERSION="0.5.0-ls-7",e.VOLUME=w,e.XHRLoader=Qe,e.ZipLoader=dt,e.applyMixins=function(e,t){t.forEach((t=>{Object.getOwnPropertyNames(t.prototype).forEach((s=>{"constructor"!==s&&Object.defineProperty(e.prototype,s,Object.getOwnPropertyDescriptor(t.prototype,s))}))}))},e.clamp=u,e.config=d,e.copyArray=g,e.copyProperty=p,e.folderName=f,e.logger=h,e.rand=c,e.remove=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
